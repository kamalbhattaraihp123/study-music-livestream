name: ðŸŽ¹ Lofi Study Music

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 300
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Install FFmpeg
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
    
    - name: Create shuffled playlist
      run: |
        for file in music/lofi/*.mp3; do
          echo "file '$file'" >> temp.txt
        done
        shuf temp.txt > playlist.txt
        echo "ðŸŽµ Playing:"
        cat playlist.txt
    
    - name: Stream
      env:
        STREAM_KEY: ${{ secrets.LOFI_STREAM_KEY }}
      run: |
        ffmpeg -loop 1 -framerate 1 -i backgrounds/lofi-bg.jpg \
          -stream_loop -1 -f concat -safe 0 -i playlist.txt \
          -c:v libx264 -preset veryfast -tune stillimage \
          -pix_fmt yuv420p -b:v 800k -maxrate 800k -bufsize 1600k \
          -vf "scale=1920:1080" -r 1 \
          -g 50 -sc_threshold 0 \
          -c:a aac -b:a 128k -ar 44100 \
          -f flv rtmp://a.rtmp.youtube.com/live2/$STREAM_KEY