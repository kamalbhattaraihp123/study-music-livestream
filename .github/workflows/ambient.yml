name: ðŸŒŠ Ambient Nature Sounds 24/7

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours at :00

jobs:
  stream-ambient:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Install FFmpeg
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
    
    - name: Create shuffled playlist
      run: |
        echo "ðŸŒŠ Creating playlist..."
        for file in music/ambient/*.mp3; do
          echo "file '$file'" >> temp.txt
        done
        shuf temp.txt > playlist.txt
        echo "âœ… Created playlist with $(wc -l < playlist.txt) tracks"
        head -3 playlist.txt
    
    - name: Stream to YouTube (Robust Mode)
      env:
        STREAM_KEY: ${{ secrets.AMBIENT_STREAM_KEY }}
      run: |
        echo "ðŸŒŠ Starting robust 24/7 stream..."
        echo "â° Will run for 6 hours before auto-restart"
        echo ""
        
        # Stream with reconnection and error handling
        ffmpeg -hide_banner -loglevel warning -stats \
          -stream_loop -1 -f concat -safe 0 -re -i playlist.txt \
          -filter_complex "[0:a]showwaves=s=1920x1080:mode=cline:colors=#3366FF|#66CCFF:scale=sqrt,format=yuv420p[v]" \
          -map "[v]" -map 0:a \
          -c:v libx264 -preset veryfast -b:v 1500k -maxrate 1500k -bufsize 3000k \
          -g 50 -keyint_min 50 -sc_threshold 0 \
          -c:a aac -b:a 128k -ar 44100 \
          -f flv \
          -flvflags no_duration_filesize \
          -reconnect 1 \
          -reconnect_at_eof 1 \
          -reconnect_streamed 1 \
          -reconnect_delay_max 10 \
          "rtmp://a.rtmp.youtube.com/live2/$STREAM_KEY" \
          || echo "âš ï¸ Stream ended (exit code: $?)"
        
        echo ""
        echo "âœ… 6-hour session completed. Next auto-restart in ~10 minutes."
