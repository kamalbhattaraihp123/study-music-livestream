name: üåä Ambient Nature Sounds 24/7

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */2 * * *'

jobs:
  stream-ambient:
    runs-on: ubuntu-latest
    timeout-minutes: 130
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Install FFmpeg
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
        echo "‚úÖ FFmpeg installed"
    
    - name: Verify files exist
      run: |
        echo "üìÅ Checking music files..."
        ls music/ambient/*.mp3 | head -5
        TRACK_COUNT=$(ls music/ambient/*.mp3 | wc -l)
        echo "‚úÖ Found $TRACK_COUNT music files"
        
        echo ""
        echo "üìÅ Checking background..."
        ls -lh backgrounds/ambient-bg.jpg || echo "‚ö†Ô∏è No background image"
    
    - name: Create shuffled playlist
      run: |
        echo "üéµ Creating playlist..."
        for file in music/ambient/*.mp3; do
          echo "file '$file'" >> temp.txt
        done
        shuf temp.txt > playlist.txt
        echo "‚úÖ Created playlist with $(wc -l < playlist.txt) tracks"
    
    - name: Prepare background image
      run: |
        echo "üñºÔ∏è Preparing background..."
        
        if [ -f backgrounds/ambient-bg.jpg ]; then
          echo "‚úÖ Found custom background"
          ffmpeg -i backgrounds/ambient-bg.jpg \
            -vf "scale=1920:1080:force_original_aspect_ratio=decrease,pad=1920:1080:(ow-iw)/2:(oh-ih)/2:color=black,format=yuv420p" \
            -q:v 2 -frames:v 1 -y bg.jpg
        else
          echo "‚ö†Ô∏è Creating blue gradient..."
          ffmpeg -f lavfi -i "color=c=#1E3A5F:s=1920x1080:d=1,format=yuv420p" \
            -frames:v 1 -y bg.jpg
        fi
        
        ls -lh bg.jpg
        echo "‚úÖ Background ready"
    
    - name: Verify stream key exists
      env:
        STREAM_KEY: ${{ secrets.AMBIENT_STREAM_KEY }}
      run: |
        echo "üîê Checking stream key..."
        if [ -z "$STREAM_KEY" ]; then
          echo "‚ùå ERROR: AMBIENT_STREAM_KEY is empty!"
          echo "Please add your YouTube stream key to GitHub Secrets"
          exit 1
        fi
        KEY_LENGTH=${#STREAM_KEY}
        echo "‚úÖ Stream key exists (length: $KEY_LENGTH characters)"
        
        if [ $KEY_LENGTH -lt 10 ]; then
          echo "‚ùå ERROR: Stream key seems too short!"
          exit 1
        fi
        echo "‚úÖ Stream key looks valid"
    
    - name: Start streaming to YouTube (2 hours)
      env:
        STREAM_KEY: ${{ secrets.AMBIENT_STREAM_KEY }}
      run: |
        echo "üåä Starting 2-hour stream..."
        echo "üñºÔ∏è Background: bg.jpg"
        echo "üéµ Tracks: $(wc -l < playlist.txt)"
        echo "‚è∞ Duration: 2 hours"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo ""
        echo "If this fails immediately, your stream key may be wrong!"
        echo ""
        
        # Run FFmpeg and capture output
        ffmpeg -hide_banner -loglevel info \
          -re -loop 1 -r 30 -i bg.jpg \
          -stream_loop -1 -f concat -safe 0 -i playlist.txt \
          -c:v libx264 -preset veryfast -profile:v high \
          -pix_fmt yuv420p \
          -b:v 2500k -maxrate 2500k -bufsize 5000k \
          -r 30 -g 60 -keyint_min 60 -sc_threshold 0 \
          -c:a aac -b:a 128k -ar 44100 -ac 2 \
          -f flv \
          "rtmp://a.rtmp.youtube.com/live2/$STREAM_KEY" 2>&1 | head -100 &
        
        FFMPEG_PID=$!
        
        # Wait a bit and check if FFmpeg is still running
        sleep 30
        
        if kill -0 $FFMPEG_PID 2>/dev/null; then
          echo ""
          echo "‚úÖ Stream started successfully!"
          echo "‚úÖ FFmpeg is running (PID: $FFMPEG_PID)"
          echo "‚úÖ Check YouTube Studio - should show LIVE"
          echo ""
          echo "Streaming for 2 hours..."
          
          # Wait for the rest of the 2 hours
          wait $FFMPEG_PID || true
          echo "‚úÖ Stream session completed"
        else
          echo ""
          echo "‚ùå ERROR: FFmpeg stopped within 30 seconds!"
          echo ""
          echo "Possible causes:"
          echo "1. Stream key is wrong or expired"
          echo "2. YouTube stream is not active"
          echo "3. Network connection issue"
          echo ""
          echo "Please:"
          echo "1. Create a NEW stream in YouTube Studio"
          echo "2. Copy the NEW stream key"
          echo "3. Update AMBIENT_STREAM_KEY in GitHub Secrets"
          exit 1
        fi
