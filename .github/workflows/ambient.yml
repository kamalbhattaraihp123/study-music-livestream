name: ğŸŒŠ Ambient Nature Sounds 24/7

on:
  workflow_dispatch:
  schedule:
    - cron: '10 */6 * * *'

jobs:
  stream-ambient:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Install FFmpeg
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
    
    - name: Create shuffled playlist
      run: |
        echo "ğŸŒŠ Creating ambient playlist..."
        for file in music/ambient/*.mp3; do
          echo "file '$file'" >> temp.txt
        done
        shuf temp.txt > playlist.txt
        echo "ğŸ“‹ Playlist created with $(wc -l < playlist.txt) tracks"
        head -5 playlist.txt
    
    - name: Prepare background image
      run: |
        if [ -f backgrounds/ambient-bg.jpg ]; then
          echo "âœ… Found: backgrounds/ambient-bg.jpg"
          ffmpeg -i backgrounds/ambient-bg.jpg \
            -vf "scale=1920:1080:force_original_aspect_ratio=decrease,pad=1920:1080:-1:-1:color=black,format=yuv420p" \
            -q:v 2 -y ambient-bg-resized.jpg
          echo "âœ… Background resized"
        else
          echo "âš ï¸ Creating gradient background..."
          ffmpeg -f lavfi \
            -i "color=c=0x1E3A5F:s=1920x1080:d=1,format=yuv420p" \
            -frames:v 1 -y ambient-bg-resized.jpg
        fi
        ls -lh ambient-bg-resized.jpg
    
    - name: Test YouTube connection
      env:
        STREAM_KEY: ${{ secrets.AMBIENT_STREAM_KEY }}
      run: |
        echo "ğŸ” Testing YouTube RTMP connection..."
        if [ -z "$STREAM_KEY" ]; then
          echo "âŒ ERROR: STREAM_KEY is empty!"
          exit 1
        fi
        echo "âœ… Stream key exists (length: ${#STREAM_KEY} characters)"
        echo "âœ… Ready to stream!"
    
    - name: Stream to YouTube
      env:
        STREAM_KEY: ${{ secrets.AMBIENT_STREAM_KEY }}
      run: |
        echo "ğŸŒŠ Starting 24/7 stream to YouTube..."
        echo "ğŸ–¼ï¸ Background: ambient-bg-resized.jpg"
        echo "ğŸµ Playlist: $(wc -l < playlist.txt) tracks"
        echo ""
        echo "â° Stream will run for 6 hours..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        ffmpeg -hide_banner \
          -loop 1 -framerate 1 -i ambient-bg-resized.jpg \
          -stream_loop -1 -f concat -safe 0 -i playlist.txt \
          -c:v libx264 -preset veryfast -tune stillimage \
          -pix_fmt yuv420p -b:v 1000k -maxrate 1000k -bufsize 2000k \
          -r 1 -g 50 -keyint_min 50 -sc_threshold 0 \
          -c:a aac -b:a 128k -ar 44100 \
          -f flv "rtmp://a.rtmp.youtube.com/live2/$STREAM_KEY"
